<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>MundoIn — Sincronizador Sucursales</title>

<style>
:root {
  --bg:#0f172a;
  --panel:#111827;
  --text:#e5e7eb;
  --primary:#22c55e;
  --border:#1f2937;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  justify-content:center;
  padding:40px;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:2rem;
  width:100%;
  max-width:640px;
}
h2{text-align:center;margin:0 0 10px}
p{text-align:center;color:#94a3b8;margin-bottom:20px}
input[type=file]{
  width:100%;
  padding:12px;
  background:#020617;
  border:1px dashed #334155;
  border-radius:8px;
  color:white;
  margin-bottom:20px;
}
button{
  width:100%;
  padding:14px;
  border-radius:8px;
  border:none;
  font-weight:bold;
  background:var(--primary);
  cursor:pointer;
}
button:disabled{opacity:.5}
#log{
  margin-top:20px;
  background:black;
  padding:15px;
  border-radius:8px;
  max-height:360px;
  overflow:auto;
  font-family:monospace;
  font-size:13px;
}
.green{color:#22c55e}
.red{color:#ef4444}
.blue{color:#3b82f6}
.yellow{color:#eab308}
</style>
</head>

<body>
<div class="card">
  <h2>Sincronizador MundoIn</h2>
  <p>Metafield destino: <b>custom.sucursales</b></p>

  <input type="file" id="csvFile" accept=".csv" />
  <button id="btn">Iniciar sincronización</button>

  <div id="log">Esperando CSV…</div>
</div>

<script>
const btn = document.getElementById('btn');
const log = document.getElementById('log');

function addLog(msg, color='') {
  const d = document.createElement('div');
  d.className = color;
  d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  log.prepend(d);
}

btn.onclick = async () => {
  const file = document.getElementById('csvFile').files[0];
  if (!file) return alert('Selecciona un CSV');

  btn.disabled = true;
  log.innerHTML = '';
  addLog('Leyendo archivo...', 'blue');

  try {
    const text = await file.text();
    const clean = text.replace(/\uFEFF/g,'').trim();
    const lines = clean.split(/\r?\n/).filter(Boolean);

    if (lines.length < 2) throw new Error('CSV vacío');

    const headers = lines[0].split(',').map(h=>h.trim());
    const rows = lines.slice(1);

    const idx = {
      id: headers.indexOf('ID'),
      handle: headers.indexOf('Handle'),
      opt1: headers.indexOf('Option1 Value'),
      opt2: headers.indexOf('Option2 Value'),
      sku: headers.indexOf('SKU'),
      web: headers.indexOf('WEB')
    };

    if (idx.web === -1) throw new Error('No existe columna WEB');

    const sucHeaders = headers.slice(idx.web);

    addLog(`Columnas de sucursales detectadas: ${sucHeaders.length}`, 'yellow');

    const productos = {};

    rows.forEach(line => {
      const c = line.split(',').map(v=>v.trim());
      const handle = c[idx.handle];
      if (!handle) return;

      if (!productos[handle]) {
        productos[handle] = {
          handle,
          sucursales: sucHeaders.map(s => ({
            nombre: s,
            mapa: `https://www.google.com/maps/search/${encodeURIComponent(s)}`
          })),
          variantes: []
        };
      }

      const cantidades = sucHeaders.map((_,i)=>{
        const v = parseInt(c[idx.web + i] || 0);
        return isNaN(v) ? 0 : v;
      });

      productos[handle].variantes.push({
        opciones: [
          { nombre:'Tamaño', valor: c[idx.opt1] || '' },
          { nombre:'Color', valor: c[idx.opt2] || '' }
        ],
        sku: c[idx.sku] || '',
        cantidades
      });
    });

    const total = Object.keys(productos).length;
    addLog(`Productos listos: ${total}`, 'yellow');

    for (const handle in productos) {
      addLog(`→ ${handle}`, 'blue');

      const payload = {
        sucursales: productos[handle].sucursales,
        variantes: productos[handle].variantes
      };

      const res = await fetch('/api/metafield', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          handle,
          value: payload
        })
      });

      const j = await res.json();
      if (!j.ok) {
        addLog(`✗ ${handle}: ${j.error}`, 'red');
      } else {
        addLog(`✓ ${handle}: OK`, 'green');
      }

      await new Promise(r=>setTimeout(r,600));
    }

    addLog('SINCRONIZACIÓN TERMINADA', 'green');

  } catch (e) {
    addLog(`ERROR: ${e.message}`, 'red');
    console.error(e);
  } finally {
    btn.disabled = false;
  }
};
</script>
</body>
</html>
