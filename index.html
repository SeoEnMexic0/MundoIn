<script>
const HANDLE='cama-luton';
const SUCURSALES=[
 'stock_centro','suc_coyoacan','suc_benito_juarez',
 'suc_gustavo_baz','suc_naucalpan','suc_toluca',
 'suc_queretaro','suc_vallejo','suc_puebla'
];

// Carga todos los productos existentes
async function cargar(){
  const res=await fetch(`/api/metafield?handle=${HANDLE}`);
  const j=await res.json();

  fila.innerHTML=''; // limpia pero vamos a agregar todo

  // Si hay múltiples productos, iterar; si solo uno, usar ejemplo
  const productos = j.productos || [{
    sku:'RECA0904851',
    nombre:'Cama Luton Gris',
    variante:'Individual',
    stocks:j.stocks
  }];

  productos.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="cell-input" value="${p.sku}" readonly></td>
      <td><input class="cell-input" value="${p.nombre}" readonly></td>
      <td><input class="cell-input" value="${p.variante}" readonly></td>
      ${SUCURSALES.map(k=>`
        <td><input class="cell-input stock-cell" data-key="${k}" value="${p.stocks?.[k]||0}"></td>
      `).join('')}
    `;
    fila.appendChild(tr);
  });
}

// Guardar cambios
async function guardar(){
  const data={};
  document.querySelectorAll('[data-key]').forEach(i=>{
    data[i.dataset.key]=Number(i.value);
  });

  await fetch('/api/metafield',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({handle:HANDLE,stocks:data})
  });

  toast.style.display='flex';
  setTimeout(()=>toast.style.display='none',2000);
}

// Filtro de búsqueda
searchBox.addEventListener('input',()=> {
  const term = searchBox.value.toLowerCase();
  document.querySelectorAll('#fila tr').forEach(tr=>{
    const sku = tr.children[0].querySelector('input').value.toLowerCase();
    const name = tr.children[1].querySelector('input').value.toLowerCase();
    tr.style.display = sku.includes(term) || name.includes(term) ? '' : 'none';
  });
});

// Agregar nuevo producto
function agregarProducto(){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input class="cell-input" value="${newSku.value}" readonly></td>
    <td><input class="cell-input" value="${newName.value}" readonly></td>
    <td><input class="cell-input" value="${newVariante.value}" readonly></td>
    ${SUCURSALES.map(k=>{
      const val = document.getElementById('new-stock-' + k.split('_')[1])?.value || 0;
      return `<td><input class="cell-input stock-cell" data-key="${k}" value="${val}"></td>`;
    }).join('')}
  `;
  fila.appendChild(tr);
  modalNew.style.display='none';
  [newSku,newName,newVariante,...document.querySelectorAll('#modal-new input')].forEach(i=>i.value='');
}

window.onload=cargar;
</script>
