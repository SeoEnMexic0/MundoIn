<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MundoIn â€” Subir CSV</title>
    <style>
      :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --primary:#22c55e; --border:#1f2937; }
      *{box-sizing:border-box}
      body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";background:radial-gradient(1200px 800px at 80% -200px,#1e293b 20%,transparent 60%),var(--bg);color:var(--text);min-height:100vh;display:grid;align-items:start}
      .container{width:100%;max-width:720px;margin:3rem auto;padding:0 1rem}
      .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:16px;padding:1.25rem;box-shadow:0 20px 40px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.04)}
      h1{font-size:1.5rem;margin:0 0 .5rem}
      p.desc{color:var(--muted);margin:0 0 1rem}
      label{display:block;font-weight:600;margin-bottom:.5rem}
      .file-row{display:grid;grid-template-columns:1fr auto;gap:.75rem;align-items:center}
      input[type="file"]{width:100%;padding:.75rem;border-radius:12px;border:1px dashed var(--border);background:#0b1220;color:var(--text)}
      .hint{color:var(--muted);font-size:.9rem;margin-top:.5rem}
      .file-info{margin-top:.5rem;font-size:.95rem}
      .hidden{display:none}
      button{appearance:none;border:1px solid transparent;border-radius:12px;padding:.75rem 1rem;background:linear-gradient(180deg,var(--primary),#16a34a);color:#fff;font-weight:600;cursor:pointer;transition:transform .06s ease,filter .2s ease,opacity .2s ease}
      button:disabled{opacity:.6;cursor:not-allowed}
      button:hover:not(:disabled){filter:brightness(1.05)}
      button:active:not(:disabled){transform:translateY(1px)}
      .note{border-left:3px solid var(--primary);padding:.75rem;background:#0b1220;border-radius:8px;color:var(--muted);margin-top:1rem}
      .actions{display:flex;gap:.75rem;margin-top:1rem}
    </style>
  </head>
  <body>
    <main class="container">
      <section class="card" aria-labelledby="csv-title">
        <h1 id="csv-title">Subir archivo CSV</h1>
        <p class="desc">Selecciona un archivo con extensiÃ³n .csv para continuar.</p>

        <form id="csv-form" novalidate>
          <label for="csvFile">Archivo CSV</label>
          <div class="file-row">
            <input id="csvFile" name="csvFile" type="file" accept=".csv,text/csv" aria-describedby="csv-hint" required />
            <button type="submit" id="submitBtn" disabled>Continuar</button>
          </div>
          <div id="csv-hint" class="hint">Formatos aceptados: .csv (texto separado por comas)</div>
          <div id="fileInfo" class="file-info hidden"></div>
        </form>
        <div class="note">El Admin API debe apuntar a <b>mundo-jm-test.myshopify.com</b> (no al dominio custom).</div>
      </section>
    </main>

    <script>
      // ======= CONFIG FRONT =======
      const STORE   = 'mundo-jm-test.myshopify.com';
      const VERSION = '2024-07';
      const TOP_KEY = 'sucursales'; // Cambiar de 'mx_cdmx' a 'sucursales'
      const TOKEN   = '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';
      // ============================

      const input = document.getElementById('csvFile');
      const info  = document.getElementById('fileInfo');
      const btn   = document.getElementById('submitBtn');

      function isCsv(file){
        if(!file) return false;
        const nameOk = /\.csv$/i.test(file.name||'');
        const typeOk = file.type === 'text/csv' || file.type === 'application/vnd.ms-excel' || file.type === '';
        return nameOk || typeOk;
      }

      function parseCSV(text){
        const rows=[]; let row=[]; let cur=''; let inQuotes=false;
        for(let i=0;i<text.length;i++){
          const c=text[i], n=text[i+1];
          if(inQuotes){
            if(c==='"' && n === '"'){ cur+='"'; i++; continue; }
            if(c=== '"'){ inQuotes=false; continue; }
            cur+=c;
          }else{
            if(c=== '"'){ inQuotes=true; continue; }
            if(c=== ','){ row.push(cur); cur=''; continue; }
            if(c=== '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; continue; }
            if(c=== '\r'){ continue; }
            cur+=c;
          }
        }
        if(cur.length>0 || row.length){ row.push(cur); rows.push(row); }
        return rows;
      }

      function buildJsonFromCsv(rows){
        if(!rows || rows.length<2) return [];
        const header = rows[0] || [];
        const startIdx = 12; // Columna M
        const items = [];
        
        // Mapas personalizados para cada sucursal
        const mapasPersonalizados = {
          'WEB': '',
          'Suc. Centro': 'https://maps.app.goo.gl/DYLcSk3kiuq8MvR69',
          'Suc. CoyoacÃ¡n': 'https://maps.app.goo.gl/wVhL3Q5FCHssQKDY9',
          'Suc. Benito JuÃ¡rez': 'https://maps.app.goo.gl/bFWnRxQWxuyKcAMJ8',
          'Suc. Gustavo Baz': 'https://maps.app.goo.gl/85r1oTFbUcE3SPEM8',
          'Suc. Naucalpan': 'https://maps.app.goo.gl/8mik8gVeJCyU3Jvj8',
          'Suc. Vallejo': 'https://maps.app.goo.gl/VvLtpqGBJyr2SQWt7',
          'Suc. Toluca': 'https://maps.app.goo.gl/xjo371LXqNiwf7pY8',
          'Suc. QuerÃ©taro': 'https://maps.app.goo.gl/6Aw6PxJGjWCDEeXm8',
          'Suc. Puebla': 'https://maps.app.goo.gl/vT6rAdNFiDawF6vb6'
        };
        
        for(let r=1;r<rows.length;r++){
          const row = rows[r] || [];
          const id = (row[0] ?? '').toString().trim();
          const handle = (row[1] ?? '').toString().trim();
          if(!id && !handle) continue;
          const sucursales=[];
          for(let c=startIdx;c<header.length;c++){
            const nombre = String(header[c] ?? '').replace(/\xa0/g, ' ').trim();
            if(!nombre) continue;
            const raw = (row[c] ?? '').toString().trim();
            const num = raw === '' ? 0 : Number(raw.replace(/[^0-9.-]/g,''));
            
            // Buscar mapa personalizado o usar genÃ©rico
            let mapaUrl = mapasPersonalizados[nombre];
            if (!mapaUrl) {
              // Si no hay mapa personalizado, usar el genÃ©rico
              mapaUrl = `https://maps.google.com/?q=${encodeURIComponent(nombre)}`;
            }
            
            sucursales.push({ 
              nombre, 
              mapa: mapaUrl, 
              cantidad: Number.isFinite(num) ? num : 0 
            });
          }
          items.push({ ID:id, Handle:handle, sucursales });
        }
        return items;
      }

      function normalizeProductId(id){
        const s = String(id||'').trim();
        const m = s.match(/\d+$/);
        return m ? m[0] : s;
      }

      async function pushByHandle({ token, handle, sucursales }){
        const valueObj = { [TOP_KEY]: sucursales };
        const res = await fetch('/metafield_by_handle',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ store: STORE, version: VERSION, token, handle, value: valueObj })
        });
        const data = await res.json();
        if(!res.ok || !data.ok) throw new Error(data?.error || `HTTP ${res.status}`);
        return data;
      }

      async function pushById({ token, productId, sucursales }){
        const valueObj = { [TOP_KEY]: sucursales };
        const res = await fetch('/metafield',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ store: STORE, version: VERSION, token, product_id: normalizeProductId(productId), value: valueObj })
        });
        const data = await res.json();
        if(!res.ok || !data.ok) throw new Error(data?.error || `HTTP ${res.status}`);
        return data;
      }

      async function updateAllProductsFromCSV(rows, token){
        const items = buildJsonFromCsv(rows);
        const results=[];
        for(const it of items){
          const productId = normalizeProductId(it.ID || '');
          const handle = String(it.Handle || '').trim().toLowerCase();
          try{
            if(productId){
              const r = await pushById({ token, productId, sucursales: it.sucursales });
              results.push({ productId, ok:true, via:'product_id', status:r.status });
            }else if(handle){
              const r = await pushByHandle({ token, handle, sucursales: it.sucursales });
              results.push({ handle, ok:true, via:'handle', gid:r.gid });
            }else{
              results.push({ ok:false, error:'Fila sin ID ni Handle' });
            }
          }catch(e){
            results.push({ ok:false, handle, productId, error:e.message });
          }
          await new Promise(r=>setTimeout(r, 300));
        }
        return results;
      }

      input.addEventListener('change', ()=>{
        const file = input.files && input.files[0];
        if(file && isCsv(file)){
          const sizeKB = (file.size/1024).toFixed(1);
          info.textContent = `Seleccionado: ${file.name} (${sizeKB} KB)`;
          info.classList.remove('hidden');
          btn.disabled = false;
        }else{
          info.textContent = 'Por favor selecciona un archivo .csv vÃ¡lido.';
          info.classList.remove('hidden');
          btn.disabled = true;
          if (input.value) input.value = '';
        }
      });

      btn.addEventListener('click', async (e)=>{
        e.preventDefault();
        const file = input.files && input.files[0];
        if(!file || !isCsv(file)) {
          alert('Error: El archivo seleccionado no es vÃ¡lido. Por favor, selecciÃ³nalo de nuevo.');
          return;
        }

        const token = TOKEN; // Usar el token configurado
        if(!token) return;

        btn.disabled = true;
        try{
          const text = await file.text();
          const rows = parseCSV(text);
          const items = buildJsonFromCsv(rows);
          console.log('[JSON] Transformado. Total filas:', items.length);
          console.log('[JSON] Primeros elementos:', items.slice(0,2));

          // Guardar CSV crudo
          const fd = new FormData(); fd.append('file', file, file.name);
          const up = await fetch('/upload',{ method:'POST', body:fd });
          const upData = await up.json();
          if(!up.ok || !upData.ok) throw new Error(upData.error || `Error ${up.status} al guardar CSV`);
          info.textContent = `Guardado como: ${upData.filename} en ${upData.path}`;
          info.classList.remove('hidden');

          // Actualizar (prioriza ID, sirve tambiÃ©n en borradores)
          const results = await updateAllProductsFromCSV(rows, token);
          console.log('[Shopify] Resultados:', results);
          
          // Mostrar informaciÃ³n detallada de cada resultado
          results.forEach((result, index) => {
            console.log(`\n=== PRODUCTO ${index + 1} ===`);
            console.log('âœ… Ã‰xito:', result.ok);
            if (result.ok) {
              console.log('ðŸ†” GID:', result.gid);
              console.log('ðŸ·ï¸ Handle:', result.handle);
              if (result.metafield_details) {
                console.log('ðŸ“‹ METACAMPO ACTUALIZADO:');
                console.log('  - Namespace:', result.metafield_details.namespace);
                console.log('  - Key:', result.metafield_details.key);
                console.log('  - Tipo:', result.metafield_details.type);
                console.log('  - Valor enviado:', result.metafield_details.value_sent);
                console.log('  - Valor almacenado:', result.metafield_details.value_stored);
                console.log('  - Tipo almacenado:', result.metafield_details.value_type_stored);
              }
            } else {
              console.log('âŒ Error:', result.error);
            }
          });
          const okCount = results.filter(r=>r.ok).length;
          const fail = results.filter(r=>!r.ok);
          alert(fail.length ? `Actualizados ${okCount}/${results.length}. Fallaron ${fail.length} (ver consola).`
                             : `Â¡Listo! Actualizados ${okCount}/${results.length} productos.`);
          
          // Limpiar y deshabilitar al terminar con Ã©xito
          input.value = '';
          btn.disabled = true;
          info.textContent = 'Proceso completado. Selecciona un nuevo archivo para comenzar de nuevo.';

        }catch(err){
          alert('Fallo: ' + (err?.message || err));
          btn.disabled = false; // Rehabilitar el botÃ³n si ocurre un error.
        }
      });
    </script>
  </body>
</html>