<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editor de Stock ‚Äî Mundo In</title>
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<style>
:root{
  --brand:#184E56;
  --brand-dark:#123a40;
  --excel-green:#107c41;
  --border:#d1d5db;
  --header-bg:#f3f4f6;
  --selection:#e7f3f0;
}
body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  margin:0;
  background:#fff;
  color:#333;
  display:flex;
  flex-direction:column;
  height:100vh;
  overflow:hidden;
}
nav{
  background:var(--brand);
  padding:10px 20px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  color:#fff;
}
.logo-area{display:flex;align-items:center;gap:15px}
.search-excel{
  background:rgba(255,255,255,.15);
  border:1px solid rgba(255,255,255,.2);
  border-radius:6px;
  padding:8px 15px;
  width:300px;
  color:#fff;
  outline:none;
}
.toolbar{
  background:#fff;
  padding:8px 20px;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  gap:25px;
  font-size:13px;
}
.btn-tool{
  display:flex;
  align-items:center;
  gap:6px;
  cursor:pointer;
  padding:6px 10px;
  border-radius:4px;
}
.btn-tool:hover{background:#f3f4f6;color:var(--brand)}
.btn-save-main{color:var(--excel-green)}
.grid-container{
  flex:1;
  overflow:auto;
  background:#f8fafc;
}
table{
  border-collapse:collapse;
  width:max-content;
  min-width:100%;
  background:#fff;
}
th{
  background:var(--header-bg);
  position:sticky;
  top:0;
  z-index:10;
  padding:10px 15px;
  border:1px solid var(--border);
  font-size:11px;
  font-weight:700;
  text-transform:uppercase;
  color:#4b5563;
}
th:nth-child(1),td:nth-child(1),
th:nth-child(2),td:nth-child(2){
  position:sticky;
  left:0;
  z-index:11;
}
td{
  border:1px solid var(--border);
  padding:0;
}
.cell-input{
  width:100%;
  height:38px;
  border:2px solid transparent;
  padding:0 10px;
  background:transparent;
  outline:none;
  font-size:13px;
}
.cell-input:focus{
  background:#fff;
  border-color:var(--excel-green);
}
.stock-cell{
  width:90px;
  text-align:center;
  font-weight:700;
  color:var(--brand);
}
tr:hover td{background:var(--selection)}
footer{
  background:#f3f4f6;
  border-top:1px solid var(--border);
  padding:4px 20px;
  display:flex;
  justify-content:space-between;
  font-size:11px;
  color:#6b7280;
}
.toast{
  position:fixed;
  bottom:30px;
  right:30px;
  background:#1f2937;
  color:#fff;
  padding:12px 20px;
  border-radius:8px;
  display:none;
  align-items:center;
  gap:10px;
}
#csv-log{
  max-height:200px;
  overflow:auto;
  margin:10px 20px;
  padding:10px;
  background:#f3f4f6;
  border-radius:8px;
  font-size:12px;
  color:#111;
}
</style>
</head>
<body>

<nav>
  <div class="logo-area">
    <img src="https://cdn.shopify.com/s/files/1/1233/2374/files/Frame_2_1.png" width="110">
    <span style="opacity:.9;font-size:13px">CONTROL DE INVENTARIO</span>
  </div>
  <input id="search-input" class="search-excel" placeholder="üîç Buscar SKU o producto">
  <div>
    <i class="ph ph-bell"></i>
    <i class="ph ph-user-circle"></i>
  </div>
</nav>

<div class="toolbar">
  <div class="btn-tool btn-save-main" onclick="guardar()">
    <i class="ph-fill ph-floppy-disk"></i> Guardar cambios
  </div>
  <div class="btn-tool" onclick="mostrarModalNuevo()">
    <i class="ph ph-plus-circle"></i> Agregar producto
  </div>
  <div class="btn-tool">
    <input type="file" id="csv-file" accept=".csv">
  </div>
  <div style="margin-left:auto;color:#059669;font-weight:600">
    ‚óè Conectado a Base de Datos
  </div>
</div>

<div class="grid-container">
<table>
<thead>
<tr>
  <th>SKU</th>
  <th>Producto</th>
  <th>Variante</th>
  <th class="stock-cell">Centro</th>
  <th class="stock-cell">Coyoac√°n</th>
  <th class="stock-cell">Benito J.</th>
  <th class="stock-cell">Gustavo Baz</th>
  <th class="stock-cell">Naucalpan</th>
  <th class="stock-cell">Toluca</th>
  <th class="stock-cell">Quer√©taro</th>
  <th class="stock-cell">Vallejo</th>
  <th class="stock-cell">Puebla</th>
</tr>
</thead>
<tbody id="fila"></tbody>
</table>
</div>

<div id="csv-log"></div>

<footer>
  <div>SKU: RECA0904851</div>
  <div>Mundo In ¬© 2024</div>
</footer>

<div id="toast" class="toast">
  <i class="ph ph-check-circle" style="color:#22c55e"></i>
  <span>Guardado</span>
</div>

<script>
const SUCURSALES=[
 'stock_centro','suc_coyoacan','suc_benito_juarez',
 'suc_gustavo_baz','suc_naucalpan','suc_toluca',
 'suc_queretaro','suc_vallejo','suc_puebla'
];

let productos = []; // Todos los productos cargados
let filtro = '';

async function cargar(handle='cama-luton'){
  const res = await fetch(`/api/metafield?handle=${handle}`);
  const j = await res.json();
  if(!j.ok) return alert(j.error);

  const tr = document.createElement('tr');
  tr.innerHTML=`
    <td><input class="cell-input" value="${handle}" readonly></td>
    <td><input class="cell-input" value="Cama Luton Gris" readonly></td>
    <td><input class="cell-input" value="Individual" readonly></td>
    ${SUCURSALES.map(k=>`<td><input class="cell-input stock-cell" data-key="${k}" value="${j.stocks?.[k]||0}"></td>`).join('')}
  `;
  fila.innerHTML='';
  fila.appendChild(tr);
  productos=[{handle, nombre:'Cama Luton Gris', variante:'Individual', stocks:j.stocks}];
}

async function guardar(){
  const data={};
  document.querySelectorAll('[data-key]').forEach(i=>{
    data[i.dataset.key]=Number(i.value);
  });
  const handle=document.querySelector('td input.cell-input').value;

  const res=await fetch('/api/metafield',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({handle, stocks:data})
  });
  const j=await res.json();
  if(j.ok){
    toast.style.display='flex';
    setTimeout(()=>toast.style.display='none',2000);
  } else alert(j.error);
}

document.getElementById('search-input').addEventListener('input', e=>{
  filtro=e.target.value.toLowerCase();
  renderTabla();
});

function renderTabla(){
  fila.innerHTML='';
  productos.filter(p=>{
    return p.handle.toLowerCase().includes(filtro) || p.nombre.toLowerCase().includes(filtro);
  }).forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input class="cell-input" value="${p.handle}" readonly></td>
      <td><input class="cell-input" value="${p.nombre}" readonly></td>
      <td><input class="cell-input" value="${p.variante}" readonly></td>
      ${SUCURSALES.map(k=>`<td><input class="cell-input stock-cell" data-key="${k}" value="${p.stocks?.[k]||0}"></td>`).join('')}
    `;
    fila.appendChild(tr);
  });
}

// ---------- CSV ----------
document.getElementById('csv-file').addEventListener('change', async e=>{
  const file=e.target.files[0];
  if(!file) return;
  const text=await file.text();
  const lines=text.split('\n').filter(l=>l.trim());
  const headers=lines.shift().split(',');
  const csvProductos=[];
  lines.forEach(l=>{
    const obj={stocks:{}};
    const cols=l.split(',');
    headers.forEach((h,i)=>{
      const key=h.trim().toLowerCase();
      if(SUCURSALES.includes(key)) obj.stocks[key]=Number(cols[i]);
      else if(key==='sku') obj.sku=cols[i];
      else if(key==='nombre') obj.nombre=cols[i];
      else if(key==='variante') obj.variante=cols[i];
    });
    csvProductos.push(obj);
  });

  const res=await fetch('/api/metafield',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({productosCSV:csvProductos})
  });
  const j=await res.json();
  const log=document.getElementById('csv-log');
  log.innerHTML='';
  j.resultados.forEach(r=>{
    const div=document.createElement('div');
    div.textContent=`${r.sku}: ${r.ok ? '‚úÖ' : '‚ùå '+r.error}`;
    log.appendChild(div);
  });
  productos=[...productos,...csvProductos];
  renderTabla();
});

window.onload=cargar;
</script>

</body>
</html>
