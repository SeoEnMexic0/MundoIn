<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MundoIn — Actualizador de Sucursales</title>
    <style>
      :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --primary:#22c55e; --border:#1f2937; }
      *{box-sizing:border-box}
      body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:radial-gradient(1200px 800px at 80% -200px,#1e293b 20%,transparent 60%),var(--bg);color:var(--text);min-height:100vh;display:grid;align-items:start}
      .container{width:100%;max-width:720px;margin:3rem auto;padding:0 1rem}
      .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:16px;padding:1.25rem;box-shadow:0 20px 40px rgba(0,0,0,.35)}
      h1{font-size:1.5rem;margin:0 0 .5rem}
      p.desc{color:var(--muted);margin:0 0 1rem}
      label{display:block;font-weight:600;margin-bottom:.5rem}
      .file-row{display:grid;grid-template-columns:1fr auto;gap:.75rem;align-items:center}
      input[type="file"]{width:100%;padding:.75rem;border-radius:12px;border:1px dashed var(--border);background:#0b1220;color:var(--text)}
      .hidden{display:none}
      button{appearance:none;border:none;border-radius:12px;padding:.75rem 1rem;background:linear-gradient(180deg,var(--primary),#16a34a);color:#fff;font-weight:600;cursor:pointer}
      button:disabled{opacity:.6;cursor:not-allowed}
      .note{border-left:3px solid var(--primary);padding:.75rem;background:#0b1220;border-radius:8px;color:var(--muted);margin-top:1rem;font-size:0.9rem}
      .progress-bar{width:100%;height:8px;background:var(--border);border-radius:4px;margin:.5rem 0;overflow:hidden}
      .progress-fill{height:100%;background:#22c55e;transition:width .3s}
      .result-item{margin:.25rem 0;padding:.25rem 0;border-bottom:1px solid var(--border);font-size:0.85rem}
      .result-error{color:#ef4444}
      .summary-box{margin-top:1rem;padding:.75rem;background:var(--border);border-radius:8px;font-weight:bold}
    </style>
  </head>
  <body>
    <main class="container">
      <section class="card">
        <h1>Actualizar Sucursales (CSV)</h1>
        <p class="desc">Sube el archivo para sincronizar inventarios en Shopify.</p>

        <form id="csv-form">
          <label for="csvFile">Archivo de Inventario</label>
          <div class="file-row">
            <input id="csvFile" type="file" accept=".csv" required />
            <button type="submit" id="submitBtn" disabled>Continuar</button>
          </div>
          <div id="fileInfo" class="file-info hidden"></div>
          <div id="csvProgress" class="hidden"></div>
          <div id="csvResults" class="hidden"></div>
        </form>
        <div class="note">Conectado a: <b>mundo-jm-test.myshopify.com</b></div>
      </section>
    </main>

    <script>
      const TOP_KEY = 'sucursales';
      const input = document.getElementById('csvFile');
      const btn = document.getElementById('submitBtn');

      // 1. Parsear CSV a Filas
      function parseCSV(text) {
        return text.split('\n').filter(line => line.trim() !== '').map(line => line.split(','));
      }

      // 2. Normalizar IDs
      function normalizeProductId(id) {
        const s = String(id || '').trim();
        const m = s.match(/\d+$/);
        return m ? m[0] : s;
      }

      // 3. Llamadas al Backend (API)
      async function pushByHandle({ handle, data }) {
        const res = await fetch('/api/metafield_by_handle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ handle, value: { [TOP_KEY]: data } })
        });
        return await res.json();
      }

      async function pushById({ productId, data }) {
        const res = await fetch('/api/metafield', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ product_id: normalizeProductId(productId), value: { [TOP_KEY]: data } })
        });
        return await res.json();
      }

      // 4. Transformar datos (Estructura de Sucursales)
      function buildProductData(row, headers) {
        const startIdx = 12; // Columna M
        const sucursales = [];
        const cantidades = [];
        
        for (let c = startIdx; c < headers.length; c++) {
          const nombre = headers[c].trim();
          if (!nombre) continue;
          sucursales.push({ nombre, mapa: "" });
          const val = row[c] ? parseInt(row[c].replace(/[^0-9]/g, '')) : 0;
          cantidades.push(isNaN(val) ? 0 : val);
        }

        return {
          sucursales,
          variantes: [{ opciones: [], cantidades }]
        };
      }

      // 5. Eventos de UI
      input.addEventListener('change', () => {
        btn.disabled = !input.files.length;
      });

      document.getElementById('csv-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const file = input.files[0];
        btn.disabled = true;

        const csvProgress = document.getElementById('csvProgress');
        const csvResults = document.getElementById('csvResults');
        csvProgress.classList.remove('hidden');
        csvResults.classList.remove('hidden');
        csvResults.innerHTML = "Procesando...";

        try {
          const text = await file.text();
          const rows = parseCSV(text);
          const headers = rows[0];
          const results = [];

          csvProgress.innerHTML = `<div class="progress-bar"><div class="progress-fill" id="fill" style="width:0%"></div></div>`;
          const fill = document.getElementById('fill');

          for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const id = row[0];
            const handle = row[1]?.trim().toLowerCase();
            const data = buildProductData(row, headers);

            try {
              let r;
              if (id && id.length > 5) {
                r = await pushById({ productId: id, data });
              } else if (handle) {
                r = await pushByHandle({ handle, data });
              }
              results.push({ ok: true, item: handle || id });
            } catch (err) {
              results.push({ ok: false, item: handle || id, error: err.message });
            }

            fill.style.width = `${(i / (rows.length - 1)) * 100}%`;
          }

          const fails = results.filter(r => !r.ok);
          csvResults.innerHTML = `
            <div class="summary-box">
              Finalizado: ${results.length - fails.length} OK, ${fails.length} Errores.
            </div>
            ${fails.map(f => `<div class="result-item result-error">✗ ${f.item}: ${f.error}</div>`).join('')}
          `;

        } catch (err) {
          alert("Error crítico: " + err.message);
        } finally {
          btn.disabled = false;
        }
      });
    </script>
  </body>
</html>
