<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>MundoIn — Sincronizador Maestro v9</title>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --primary:#22c55e; --border:#1f2937; }
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding:40px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:2rem;width:100%;max-width:600px}
    h2{text-align:center}
    input,button{width:100%;padding:12px;margin-top:10px}
    button{background:var(--primary);border:none;color:white;font-weight:bold;border-radius:8px}
    #log{margin-top:20px;background:black;padding:15px;border-radius:8px;font-family:monospace;max-height:300px;overflow:auto}
    .green{color:#22c55e} .red{color:#ef4444} .blue{color:#3b82f6}
  </style>
</head>
<body>
  <div class="card">
    <h2>Sincronizador MundoIn v9</h2>
    <input type="file" id="csvFile" accept=".csv" />
    <button id="btn">Iniciar</button>
    <div id="log">Esperando CSV…</div>
  </div>

<script>
const btn = document.getElementById('btn');
const log = document.getElementById('log');

const addLog = (msg, c='') => {
  const d = document.createElement('div');
  d.className = c;
  d.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  log.prepend(d);
};

const normalize = s =>
  s.toUpperCase()
   .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
   .replace(/[^A-Z0-9_]/g,'');

btn.onclick = async () => {
  const file = document.getElementById('csvFile').files[0];
  if (!file) return alert('Selecciona un CSV');

  btn.disabled = true;
  log.innerHTML = '';
  addLog('Leyendo archivo...', 'blue');

  try {
    const text = (await file.text()).replace(/\uFEFF/g,'');
    const lines = text.split(/\r?\n/).filter(Boolean);

    const rawHeaders = lines[0].split(',');
    const headers = rawHeaders.map(normalize);

    const idx = name => headers.indexOf(name);

    if (idx('HANDLE') === -1)
      throw new Error('Falta columna HANDLE');

    const sucCols = headers
      .map((h,i)=>h.startsWith('SUC_') ? i : -1)
      .filter(i=>i!==-1);

    if (!sucCols.length)
      throw new Error('No hay columnas suc_*');

    addLog(`Columnas de sucursales detectadas: ${sucCols.length}`, 'blue');

    const rows = lines.slice(1);

    for (const line of rows) {
      const c = line.split(',');

      const payload = {
        handle: c[idx('HANDLE')],
        option1: c[idx('OPTION1')] || null,
        option2: c[idx('OPTION2')] || null,
        sku: c[idx('SKU')] || null,
        sucursales: {}
      };

      sucCols.forEach(i=>{
        payload.sucursales[
          headers[i].replace('SUC_','').toLowerCase()
        ] = Number(c[i]||0);
      });

      addLog(`→ ${payload.handle} (${payload.sku})`, 'blue');

      const r = await fetch('/api/metafield', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });

      if (!r.ok) {
        const t = await r.text();
        throw new Error(t);
      }

      addLog(`✓ OK ${payload.sku}`, 'green');
      await new Promise(r=>setTimeout(r,500));
    }

    addLog('SINCRONIZACIÓN TERMINADA', 'green');

  } catch (e) {
    addLog('ERROR: ' + e.message, 'red');
    console.error(e);
  } finally {
    btn.disabled = false;
  }
};
</script>
</body>
</html>
