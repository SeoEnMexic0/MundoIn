<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cama Luton – Stock por sucursal</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f4f5; padding: 2rem; }
h2 { text-align: center; }
table { border-collapse: collapse; width: 100%; margin-top: 1rem; background: #fff; border-radius: 8px; overflow: hidden; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
input { width: 60px; text-align: center; }
button { padding: 10px 20px; margin-top: 1rem; cursor: pointer; background: #22c55e; color: #fff; border: none; border-radius: 6px; }
button:hover { background: #16a34a; }
.success { color: green; margin-top: 1rem; }
.error { color: red; margin-top: 1rem; }
</style>
</head>
<body>

<h2>Cama Luton – Individual / Gris</h2>

<table id="tabla">
  <thead>
    <tr>
      <th>Sucursal</th>
      <th>Stock actual</th>
      <th>Nuevo</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="guardarBtn">Actualizar sucursales</button>
<div id="mensaje"></div>

<script>
const HANDLE = 'cama-luton';
const SUCURSALES = [
  "WEB","Suc. Centro","Suc. Coyoacán","Suc. Benito Juárez",
  "Suc. Gustavo Baz","Suc. Naucalpan","Suc. Toluca",
  "Suc. Querétaro","Suc. Vallejo","Suc. Puebla"
];

const tbody = document.querySelector('#tabla tbody');
const mensaje = document.getElementById('mensaje');
const guardarBtn = document.getElementById('guardarBtn');

// Función para precargar stock desde Shopify
async function cargarStock() {
  try {
    const res = await fetch('/api/metafield', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ handle: HANDLE })
    });
    const data = await res.json();

    if (!data.ok) throw new Error(data.error || 'No se pudo obtener stock');

    tbody.innerHTML = '';
    SUCURSALES.forEach((suc, i) => {
      const cantidad = data.sucursales.find(s => s.nombre === suc)?.cantidad || 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${suc}</td>
        <td>${cantidad}</td>
        <td><input data-suc="${suc}" value="${cantidad}"></td>
      `;
      tbody.appendChild(tr);
    });
  } catch(e) {
    mensaje.innerHTML = `<div class="error">Error al cargar stock: ${e.message}</div>`;
  }
}

// Función para guardar cambios
guardarBtn.addEventListener('click', async () => {
  const cambios = {};
  document.querySelectorAll('input').forEach(input => {
    const val = Number(input.value);
    if (!isNaN(val)) cambios[input.dataset.suc] = val;
  });

  try {
    const res = await fetch('/api/metafield', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ handle: HANDLE, cambios })
    });
    const j = await res.json();
    if (j.ok) {
      mensaje.innerHTML = `<div class="success">✔ Metafield actualizado correctamente</div>`;
      cargarStock(); // refrescar tabla
    } else {
      mensaje.innerHTML = `<div class="error">✗ Error: ${j.error}</div>`;
    }
  } catch(e) {
    mensaje.innerHTML = `<div class="error">✗ Error: ${e.message}</div>`;
  }
});

// Cargar stock al inicio
cargarStock();
</script>

</body>
</html>
