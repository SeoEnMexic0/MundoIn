<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>MundoIn Sincronizador v4</title>
    <style>
        :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --primary:#22c55e; --border:#1f2937; }
        body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding:40px}
        .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:2rem;width:100%;max-width:600px}
        input[type="file"]{margin:20px 0;width:100%;padding:10px;background:#0b1220;color:white;border:1px dashed #334155;border-radius:8px}
        button{background:var(--primary);color:white;border:none;padding:12px;border-radius:8px;cursor:pointer;font-weight:bold;width:100%}
        #log{margin-top:20px;font-size:0.8rem;background:black;padding:15px;border-radius:8px;max-height:250px;overflow-y:auto;border:1px solid #1e293b}
        .green{color:#22c55e} .red{color:#ef4444} .yellow{color:#eab308}
    </style>
</head>
<body>
    <div class="card">
        <h2 style="margin:0">Sincronizador MundoIn</h2>
        <p style="color:#94a3b8;font-size:0.85rem">Versión de compatibilidad total (Stringify Force).</p>
        <input type="file" id="csvFile" accept=".csv" />
        <button id="btnStart">Actualizar Ahora</button>
        <div id="log">> Esperando archivo...</div>
    </div>

    <script>
        const btn = document.getElementById('btnStart');
        const log = document.getElementById('log');

        function addLog(msg, color='') {
            const div = document.createElement('div');
            div.className = color;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.prepend(div);
        }

        btn.onclick = async () => {
            const file = document.getElementById('csvFile').files[0];
            if(!file) return alert("Selecciona un CSV");
            btn.disabled = true;
            log.innerHTML = '';
            addLog("Leyendo archivo...", "yellow");

            try {
                const text = await file.text();
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
                const headers = lines[0].split(',').map(h => h.trim());
                const rows = lines.slice(1);
                const webIdx = headers.findIndex(h => h.trim().toUpperCase() === 'WEB');
                
                const productos = {};

                rows.forEach(line => {
                    const row = line.split(',');
                    if (row.length < webIdx) return;
                    const id = row[0]?.trim();
                    const handle = row[1]?.trim();
                    const key = handle || id;

                    if (!productos[key]) {
                        const sList = [];
                        for (let i = webIdx; i < headers.length; i++) {
                            sList.push({ nombre: headers[i].trim(), mapa: `https://maps.google.com/?q=${headers[i].trim()}` });
                        }
                        productos[key] = { id, handle, sucursales: sList, variantes: [] };
                    }

                    const cantidades = [];
                    for (let i = webIdx; i < headers.length; i++) {
                        cantidades.push(parseInt(row[i]?.replace(/[^0-9]/g, '') || 0));
                    }

                    productos[key].variantes.push({
                        opciones: [
                            { nombre: "Tamaño", valor: row[4]?.trim() || "" },
                            { nombre: "Color", valor: row[6]?.trim() || "" }
                        ],
                        cantidades: cantidades
                    });
                });

                for (const key in productos) {
                    const p = productos[key];
                    const isRealId = p.id && p.id.length > 12 && /^\d+$/.test(p.id);
                    
                    // ESTRUCTURA EXACTA SEGÚN TU JSON
                    const rawJson = {
                        sucursales: {
                            sucursales: p.sucursales,
                            variantes: p.variantes
                        }
                    };

                    addLog(`Sincronizando ${p.handle}...`, "yellow");

                    const endpoint = isRealId ? '/api/metafield' : '/api/metafield_by_handle';
                    
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            handle: p.handle,
                            product_id: isRealId ? p.id : null,
                            // ENVIAMOS EL JSON COMO STRING (Shopify Requirement)
                            value: JSON.stringify(rawJson) 
                        })
                    });

                    const data = await res.json();
                    if(data.ok) addLog(`✓ ${p.handle}: Actualizado OK`, "green");
                    else addLog(`✗ ${p.handle}: ${data.error}`, "red");
                }
                addLog("--- PROCESO TERMINADO ---", "green");
            } catch (e) {
                addLog("Error: " + e.message, "red");
            }
            btn.disabled = false;
        };
    </script>
</body>
</html>
