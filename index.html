<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>MundoIn — Sincronizador Maestro</title>
    <style>
        :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --primary:#22c55e; --border:#1f2937; }
        body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);display:grid;place-items:center;min-height:100vh}
        .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:2rem;width:100%;max-width:500px;text-align:center}
        input[type="file"]{margin:1rem 0;display:block;width:100%}
        button{background:var(--primary);color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold}
        #log{margin-top:1rem;font-size:0.8rem;text-align:left;max-height:200px;overflow-y:auto;background:black;padding:10px;border-radius:5px}
        .green{color:var(--primary)} .red{color:#ff4444}
    </style>
</head>
<body>
    <div class="card">
        <h2>Sincronizador MundoIn</h2>
        <input type="file" id="csvFile" accept=".csv" />
        <button id="btnStart">Actualizar Inventarios</button>
        <div id="log"></div>
    </div>

    <script>
        const btn = document.getElementById('btnStart');
        const log = document.getElementById('log');

        function addLog(msg, color='') {
            const div = document.createElement('div');
            div.className = color;
            div.textContent = msg;
            log.prepend(div);
        }

        function processRow(row, headers) {
            const webIdx = headers.findIndex(h => h.trim().toUpperCase() === 'WEB');
            
            // 1. Crear lista de sucursales con links de mapa (como tu JSON)
            const sucursalesList = [];
            const cantidades = [];
            for (let i = webIdx; i < headers.length; i++) {
                const nombre = headers[i].trim();
                if(!nombre) continue;
                sucursalesList.push({
                    nombre: nombre,
                    mapa: `http://googleusercontent.com/maps.google.com/${i - webIdx}`
                });
                const val = row[i] ? parseInt(row[i].toString().replace(/[^0-9]/g, '')) : 0;
                cantidades.push(isNaN(val) ? 0 : val);
            }

            // 2. Crear el objeto con la estructura EXACTA del JSON que compartiste
            return {
                sucursales: {
                    sucursales: sucursalesList,
                    variantes: [{
                        opciones: [
                            { nombre: "Tamaño", valor: row[4]?.trim() || "" },
                            { nombre: "Color", valor: row[6]?.trim() || "" }
                        ],
                        cantidades: cantidades
                    }]
                }
            };
        }

        btn.onclick = async () => {
            const file = document.getElementById('csvFile').files[0];
            if(!file) return alert("Sube un archivo");
            
            const text = await file.text();
            const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
            const headers = lines[0].split(',').map(h => h.trim());
            const rows = lines.slice(1);

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i].split(',');
                const handle = row[1]?.trim();
                const id = row[0]?.trim();
                const isRealId = id && id.length > 12 && /^\d+$/.test(id);

                try {
                    const finalData = processRow(row, headers);
                    
                    const endpoint = isRealId ? '/api/metafield' : '/api/metafield_by_handle';
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            handle: handle,
                            product_id: isRealId ? id : null,
                            value: finalData // Enviamos el objeto con la doble llave
                        })
                    });

                    const data = await res.json();
                    if(data.ok) addLog(`✓ ${handle} actualizado`, 'green');
                    else addLog(`✗ Error en ${handle}`, 'red');
                } catch (e) {
                    addLog(`✗ Error: ${e.message}`, 'red');
                }
            }
            addLog("--- FIN ---");
        };
    </script>
</body>
</html>
