<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>MundoIn — Sincronizador Multivariante</title>
    <style>
        :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --primary:#22c55e; --border:#1f2937; }
        body{margin:0;font-family:sans-serif;background:var(--bg);color:var(--text);display:grid;place-items:center;min-height:100vh;padding:20px}
        .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:2rem;width:100%;max-width:600px;text-align:center}
        input[type="file"]{margin:1rem 0;display:block;width:100%;padding:10px;background:#0b1220;color:white;border:1px dashed #334155;border-radius:8px}
        button{background:var(--primary);color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-weight:bold;width:100%}
        button:disabled{opacity:0.5}
        #log{margin-top:1.5rem;font-size:0.85rem;text-align:left;max-height:300px;overflow-y:auto;background:black;padding:15px;border-radius:8px;border:1px solid #1e293b;line-height:1.6}
        .green{color:#22c55e} .red{color:#ef4444} .yellow{color:#eab308}
    </style>
</head>
<body>
    <div class="card">
        <h2 style="margin-top:0">Actualizador MundoIn Pro</h2>
        <p style="color:#94a3b8;font-size:0.9rem">Sincroniza todas las variantes de un producto a la vez.</p>
        <input type="file" id="csvFile" accept=".csv" />
        <button id="btnStart">Actualizar Inventarios</button>
        <div id="log">> Esperando archivo...</div>
    </div>

    <script>
        const btn = document.getElementById('btnStart');
        const log = document.getElementById('log');

        function addLog(msg, color='') {
            const div = document.createElement('div');
            div.className = color;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            log.prepend(div);
        }

        btn.onclick = async () => {
            const file = document.getElementById('csvFile').files[0];
            if(!file) return alert("Selecciona el archivo CSV");
            
            btn.disabled = true;
            log.innerHTML = '';
            addLog("Iniciando procesamiento masivo...", "yellow");

            try {
                const text = await file.text();
                const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
                const headers = lines[0].split(',').map(h => h.trim());
                const rows = lines.slice(1);
                
                const webIdx = headers.findIndex(h => h.trim().toUpperCase() === 'WEB');

                // AGRUPAR POR PRODUCTO (HANDLE)
                const productos = {};

                rows.forEach(line => {
                    const row = line.split(',');
                    if (row.length < webIdx) return;
                    
                    const id = row[0]?.trim();
                    const handle = row[1]?.trim();
                    const key = handle || id;

                    if (!productos[key]) {
                        // Configuración inicial del producto y sucursales
                        const sucursalesList = [];
                        for (let i = webIdx; i < headers.length; i++) {
                            sucursalesList.push({
                                nombre: headers[i].trim(),
                                mapa: `http://googleusercontent.com/maps.google.com/${i - webIdx}`
                            });
                        }
                        productos[key] = {
                            id: id,
                            handle: handle,
                            sucursales: sucursalesList,
                            variantes: []
                        };
                    }

                    // Agregar esta variante al producto
                    const cantidades = [];
                    for (let i = webIdx; i < headers.length; i++) {
                        const val = parseInt(row[i]?.replace(/[^0-9]/g, '') || 0);
                        cantidades.push(val);
                    }

                    productos[key].variantes.push({
                        opciones: [
                            { nombre: "Tamaño", valor: row[4]?.trim() || "" },
                            { nombre: "Color", valor: row[6]?.trim() || "" }
                        ],
                        cantidades: cantidades
                    });
                });

                // ENVIAR CADA PRODUCTO A SHOPIFY
                const keys = Object.keys(productos);
                for (const key of keys) {
                    const p = productos[key];
                    const isRealId = p.id && p.id.length > 12 && /^\d+$/.test(p.id);
                    
                    addLog(`Sincronizando ${p.handle}...`, "yellow");

                    const finalValue = {
                        sucursales: {
                            sucursales: p.sucursales,
                            variantes: p.variantes
                        }
                    };

                    const endpoint = isRealId ? '/api/metafield' : '/api/metafield_by_handle';
                    const res = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            handle: p.handle,
                            product_id: isRealId ? p.id : null,
                            value: finalValue
                        })
                    });

                    const resData = await res.json();
                    if(resData.ok) addLog(`✓ ${p.handle} sincronizado con éxito`, "green");
                    else addLog(`✗ Error en ${p.handle}: ${resData.error}`, "red");
                    
                    await new Promise(r => setTimeout(r, 400)); // Pausa de seguridad
                }

                addLog("--- PROCESO TERMINADO ---", "green");

            } catch (e) {
                addLog("Error crítico: " + e.message, "red");
            }
            btn.disabled = false;
        };
    </script>
</body>
</html>
