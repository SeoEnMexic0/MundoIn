<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MundoIn — Sincronizador Pro</title>
    <style>
      :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --primary:#22c55e; --border:#1f2937; }
      *{box-sizing:border-box}
      body{margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:2rem 1rem}
      .container{max-width:800px;margin:0 auto}
      .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:1.5rem;box-shadow:0 10px 30px rgba(0,0,0,0.5)}
      h1{font-size:1.4rem;margin:0 0 1rem;color:#fff}
      .file-row{display:flex;gap:.5rem;margin-bottom:1rem}
      input[type="file"]{flex:1;padding:.6rem;background:#0b1220;border:1px dashed var(--border);color:var(--text);border-radius:8px}
      button{padding:.6rem 1.5rem;background:var(--primary);border:none;border-radius:8px;color:#fff;font-weight:bold;cursor:pointer}
      button:disabled{opacity:0.5}
      .log{background:#000;padding:1rem;border-radius:8px;font-family:monospace;font-size:0.8rem;max-height:300px;overflow-y:auto;border:1px solid var(--border)}
      .log-item{margin-bottom:4px;border-bottom:1px solid #111;padding-bottom:2px}
      .green{color:#22c55e} .red{color:#ef4444} .gray{color:#666}
      .progress-bar{height:6px;background:#1f2937;border-radius:3px;margin-bottom:1rem;overflow:hidden}
      .progress-fill{height:100%;background:var(--primary);width:0%;transition:width 0.2s}
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>Sincronización de Sucursales</h1>
        <div class="file-row">
          <input type="file" id="csvFile" accept=".csv" />
          <button id="btnStart" disabled>Actualizar Todo</button>
        </div>
        <div class="progress-bar"><div id="fill" class="progress-fill"></div></div>
        <div id="log" class="log"><div class="gray">> Esperando archivo...</div></div>
      </div>
    </div>

    <script>
      const input = document.getElementById('csvFile');
      const btn = document.getElementById('btnStart');
      const log = document.getElementById('log');
      const fill = document.getElementById('fill');

      input.onchange = () => btn.disabled = !input.files.length;

      function addLog(msg, color='') {
        const div = document.createElement('div');
        div.className = 'log-item ' + color;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        log.prepend(div);
      }

      // Procesa una fila del CSV para crear el JSON exacto de MundoIn
      function processRow(row, headers) {
        // En tu CSV "WEB" es la columna 12
        const webIdx = headers.findIndex(h => h.trim().toUpperCase() === 'WEB');
        if(webIdx === -1) throw new Error("No encontré la columna WEB");

        const sucursales = [];
        const cantidades = [];

        // 1. Extraer nombres de sucursales y sus stocks
        for (let i = webIdx; i < headers.length; i++) {
          sucursales.push({ nombre: headers[i].trim(), mapa: "" });
          const val = row[i] ? parseInt(row[i].toString().replace(/[^0-9]/g, '')) : 0;
          cantidades.push(isNaN(val) ? 0 : val);
        }

        // 2. Extraer variantes (USANDO LOS VALORES DE LA FILA, NO LOS HEADERS)
        // row[3] es "Tamaño", row[4] es "Individual"
        const opciones = [];
        if(row[3] && row[4]) opciones.push({ nombre: row[3].trim(), valor: row[4].trim() });
        if(row[5] && row[6]) opciones.push({ nombre: row[5].trim(), valor: row[6].trim() });
        if(row[7] && row[8]) opciones.push({ nombre: row[7].trim(), valor: row[8].trim() });

        return {
          sucursales: sucursales,
          variantes: [{ opciones, cantidades }]
        };
      }

      btn.onclick = async () => {
        const file = input.files[0];
        btn.disabled = true;
        log.innerHTML = '';
        addLog("Iniciando proceso...");

        try {
          const text = await file.text();
          const lines = text.split(/\r?\n/).filter(l => l.trim() !== '');
          const headers = lines[0].split(',').map(h => h.trim());
          const rows = lines.slice(1);

          for (let i = 0; i < rows.size || i < rows.length; i++) {
            const row = rows[i].split(',');
            if (row.length < 2) continue;

            const id = row[0]?.trim();
            const handle = row[1]?.trim();
            fill.style.width = `${((i+1)/rows.length)*100}%`;

            try {
              const stockData = processRow(row, headers);
              
              // Muy importante: Envolvemos los datos en el objeto "sucursales"
              const payload = { sucursales: stockData };

              // Forzamos búsqueda por HANDLE si el ID es corto/incorrecto
              const isRealId = id && id.length > 12 && /^\d+$/.test(id);
              const endpoint = isRealId ? '/api/metafield' : '/api/metafield_by_handle';
              const body = isRealId ? { product_id: id, value: payload } : { handle: handle, value: payload };

              const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
              });

              const resData = await res.json();
              if (resData.ok) {
                addLog(`✓ Actualizado: ${handle}`, 'green');
              } else {
                addLog(`✗ Error en ${handle}: ${resData.error}`, 'red');
              }
            } catch (e) {
              addLog(`✗ Error procesando fila ${i+1}: ${e.message}`, 'red');
            }
            await new Promise(r => setTimeout(r, 300)); // Evita bloqueos
          }
          addLog("¡PROCESO COMPLETADO!", "green");
        } catch (err) {
          addLog("Fallo crítico: " + err.message, "red");
        }
        btn.disabled = false;
      };
    </script>
  </body>
</html>
