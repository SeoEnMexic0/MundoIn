<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Metafields Sync - Sucursales</title>
<style>
  body { font-family: Arial, sans-serif; background:#f5f5f5; color:#111; padding:2rem; }
  h1 { text-align:center; }
  table { width:100%; border-collapse: collapse; margin-top:1rem; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#eee; }
  input[type=number] { width:60px; }
  button { margin-top:1rem; padding:10px 20px; font-weight:bold; cursor:pointer; }
  .success { color:green; }
  .error { color:red; }
</style>
</head>
<body>
<h1>Actualizar sucursales</h1>

<table id="sucursalesTable">
  <thead>
    <tr>
      <th>Sucursal</th>
      <th>Cantidad actual</th>
      <th>Nueva cantidad</th>
    </tr>
  </thead>
  <tbody>
    <tr><td>WEB</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Centro</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Coyoacán</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Benito Juárez</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Gustavo Baz</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Naucalpan</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Toluca</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Querétaro</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Vallejo</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
    <tr><td>Suc. Puebla</td><td class="current">0</td><td><input type="number" value="0"></td></tr>
  </tbody>
</table>

<button id="updateBtn">Actualizar sucursales</button>
<div id="message"></div>

<script>
const STORE = 'mundo-jm-test.myshopify.com'; // tu tienda
const PRODUCT_ID = '49922626060590'; // el producto a actualizar
const API = '/api/metafield';

const btn = document.getElementById('updateBtn');
const message = document.getElementById('message');

async function fetchCurrentStock() {
  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ product_id: PRODUCT_ID, value: [] })
    });
    const data = await res.json();
    if(data.ok && data.currentStock) {
      const rows = document.querySelectorAll('#sucursalesTable tbody tr');
      data.currentStock.forEach((item, i)=>{
        if(rows[i]) rows[i].querySelector('.current').textContent = item.cantidad || 0;
      });
    }
  } catch(e) { console.error(e); }
}

// Inicial: mostrar stock actual
fetchCurrentStock();

btn.addEventListener('click', async () => {
  const rows = document.querySelectorAll('#sucursalesTable tbody tr');
  const value = [];
  rows.forEach(row => {
    const nombre = row.cells[0].textContent.trim();
    const cantidad = parseInt(row.cells[2].querySelector('input').value || '0', 10);
    value.push({ nombre, cantidad });
  });

  btn.disabled = true;
  message.textContent = 'Actualizando...';
  message.className = '';

  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ product_id: PRODUCT_ID, value })
    });
    const data = await res.json();
    if(data.ok) {
      message.textContent = '✅ Sucursales actualizadas correctamente';
      message.className = 'success';
      fetchCurrentStock(); // refrescar stock
    } else {
      message.textContent = '❌ Error: ' + JSON.stringify(data.error);
      message.className = 'error';
    }
  } catch(e) {
    message.textContent = '❌ Error de conexión: ' + e.message;
    message.className = 'error';
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>
